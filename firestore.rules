rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Collection: views ---
    match /views/{docId} {
      allow read: if true;
      allow write: if true; // Allows anyone to increment views, as per ViewComponent
    }

    // --- Collection: itemRatings ---
    match /itemRatings/{docId} {
      allow read, write: if true;
      // Consider adding data validation here for 'ratingValue' etc.
    }

    // --- Collection: galleries ---
    match /galleries/{docId} {
      allow read: if true;
      allow write: if request.auth != null; // Authenticated users can create, update, delete
    }

    // --- Collection: comments ---
    match /comments/{commentId} {
      allow read: if true; // Anyone can read comments

      allow create: if request.resource.data.text is string &&
                      request.resource.data.timestamp is number &&
                      request.resource.data.itemID is string &&
                      request.resource.data.name is string &&
                      request.resource.data.country is string &&
                      (request.resource.data.userId == null || request.resource.data.userId is string);

      allow update, delete: if request.auth != null && (request.auth.uid == resource.data.userId || request.auth.uid == "zzOww3SJFEgoDKqZRsndatOSSNH3");
    }

    // --- Collection: images ---
    match /images/{imageId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId; // Only owner can read their images
      allow create: if request.auth != null; // Authenticated users can upload images
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId; // Only owner can update/delete their images
    }

     // --- Collection: notifications ---
    match /notifications/{notificationId} {
      // Permite ler se o usuário autenticado for o destinatário da notificação
      allow read: if request.auth.uid != null && request.auth.uid == resource.data.recipientId;

      // AJUSTE CRÍTICO AQUI:
      // Permite criar (adicionar) notificações SE o campo 'recipientId' for uma string não vazia.
      // Isso cobre tanto UIDs válidos quanto 'unknown_creator'.
      // Não exige autenticação (request.auth != null) para criação,
      // permitindo notificações de usuários anônimos e para destinatários desconhecidos.
      allow create: if request.resource.data.recipientId is string &&
                       request.resource.data.recipientId.length > 0;

      // Permite atualizar (ex: marcar como lida) se o usuário autenticado for o destinatário
      allow update: if request.auth.uid != null && request.auth.uid == resource.data.recipientId;

      // Ninguém pode deletar notificações diretamente pelo cliente
      allow delete: if false;
    }

    // --- Catch-all / Other collections (Genérica) ---
   match /{document=**} {
      allow read: if true;
      allow create, update, delete: if request.auth != null; // Criação/Modificação exige autenticação aqui
    }
    
     match /logs_usuarios/{document=**} {
          allow read: if true;
      	  allow write: if true;
    }
    
  }
}